<!--- Please keep the playdate crate root's comment and README.md in sync. -->

# Playdate

This crate and its related crates together provide a safe Rust API for the
[Playdate](https://play.date/) hand held gaming system.

# Requirements
Using these crates requires the [Playdate SDK](https://play.date/dev/), which has [its own
license](https://play.date/dev/sdk-license).

This crate uses unstable features in order to provide a #[no_std] library and application to run
on the Playdate simulator and hardware devices. Thus it requires use of the [Rust nightly
compiler](https://doc.rust-lang.org/1.2.0/book/nightly-rust.html).

# Getting Started

Building a #[no_std] application that is linked into a DLL file to run in the Playdate simualtor
requires a bit of extra work and Cargo setup. The dependency structure of your project will look
like this:

```
- your-game-simulator-win** (crate of type "cdylib")
  ├── [dependencies] your-game** (#[no_std] crate of type "rlib")
  |   ├── [dependencies] playdate (#[no_std] crate of type "rlib")
  |   └── [dependencies] euclid (with `default-features = false` to keep it compatible with #[no_std]) (used in the playdate API)
  ├── [build-dependencies] your-game-build** (construct and copy any game assets into $OUT_DIR/pdx_source)
  └── [build-dependencies] playdate-build

** = is specific to your game and provided by the game developer.
```

## The simulator root crate

We provide an example template crate of `your-game-simulator-win` with
[playdate-simulator-win](TODO: link). To use it, please rename and customize it for your game.
To start using it, download the latest release, unzip it and edit it as follows. See below for
more details:
1. In the `Cargo.toml` file, change the `name` to include your game's name.
1. In the `Cargo.toml` file, change the `game` dependency's `package` and `path`
1. In the `Cargo.toml` file, remove or change the `game-build` dependency's to point to your
   game's crate. `package` and `path` to point to your game's asset-generating crate.
1. If you kept the `game-build` dependency for generating assets, call it from
   `src/bin/make_pdx.rs`.

### Development Workflow

To build your game for the Windows simulator, build your customized `your-game-simulator-win`
crate, which will build your game as a dependency.

After building the game, the [playdate-simulator-win](TODO: link) crate includes 2 binaries to
help you get it onto the Playdate simulator or a hardware device.
* make_pdx
* run_simulator

#### make_pdx
Combines your built game, along with any asset files into a pdx image for the device or
simulator, which is found in `$OUT_DIR/pdx_out`.

The `your-game-build` build-time dependency seen above is an optional place to construct and
collect assets for your game that will be included by **make_pdx** when building the game's pdx
image. To do so, edit the `make_pdx.rs` file to call `your-game-build`. Assets should be
collected into `env!("PDX_SOURCE_DIR")`. For example:
```rs
  your_game_build::generate_assets(env!("PDX_SOURCE_DIR"))?;
```

The **make_pdx** binary would then include those assets into your game's pdx image.

#### run_simulator

Runs the Playdate simulator, loading the pdx image generated by **make_pdx**.

#### VSCode

If you're using VSCode, the [playdate-simulator-win](TODO: link) comes with two files to provide
tasks that build your game's pdx image and run it on the Windows simulator.
* `.vscode/settings.json`: The `"simulatorWinRoot"` variable should point to the root of the
  Windows simulator crate. By default, since the `.vscode` directory is inside that crate, it is
  `"."`. Similarly, the `"rust-analyzer.linkedProjects"` variable should point to the Windows
  simulator crate's `Cargo.toml` file. By default it is `"./Cargo.toml"`.
* `.vscode/tasks.json`: Provides the tasks to build a pdx for the Playdate Windows simulator,
  and to load it into the simulator.

When running the Windows simulator with this task, VSCode will capture the `stdout` and `stderr`
output of the game and write it to a file called `stdout.txt`.

### Panics

The `Cargo.toml` for the root cdylib crate must also set `panic = "abort"`. This is included in
the [playdate-simulator-win](TODO: link) example:
```
[profile.dev]
panic = "abort"
[profile.release]
panic = "abort"
```
Otherwise you will get a compilation error:
```
error: language item required, but not found: `eh_personality`
  |
  = note: this can occur when a binary crate with `#![no_std]` is compiled for a target where `eh_personality` is defined in the standard library
```

## Your first game

Your game's crate must include a function that will be called after the Playdate system
initializes. This function should contain your game's main game loop. It's simplest form would
look like:
```rs
#[playdate::main]
async fn main(api: playdate::Api) -> ! {
  let events = api.system.system_event_watcher();
  loop {
    match events.next().await {
      playdate::SystemEvent::NextFrame { inputs, .. } => {
        // Read inputs, update game state and draw.
      }
      _ => (),
    }
  }
}
```
Then, handle the various events that can be returned from `next()`. In particular, handle input,
update game state, and draw to the screen when the `SystemEvent::NextFrame` event happens. The
Playdate system APIs are available throught the `playdate::Api` parameter to `main()`.

Logging to the simulator's console for debugging is possible through the `playdate::log()` and
`playdate::log_error()` functions.

# License
This project is licensed under either of

* Apache License, Version 2.0, ([LICENSE-APACHE](LICENSE-APACHE) or
  https://www.apache.org/licenses/LICENSE-2.0)
* MIT license ([LICENSE-MIT](LICENSE-MIT) or https://opensource.org/licenses/MIT)

at your option.

## Contribution
Unless you explicitly state otherwise, any contribution intentionally submitted for inclusion in
cfg-if by you, as defined in the Apache-2.0 license, shall be dual licensed as above, without
any additional terms or conditions.